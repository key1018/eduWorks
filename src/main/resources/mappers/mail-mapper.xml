<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mailMapper">

	<resultMap id="mailResult" type="Mail">
		<result column="mail_no" property="mailNo" />
		<result column="mem_no" property="memNo" />
		<result column="tag_no" property="tagNo" />
		<result column="mail_temporary" property="mailTemporary" />
		<result column="receiver_mem" property="receiverMem" />
		<result column="cc_mem" property="ccMem" />
		<result column="mail_title" property="mailTitle" />
		<result column="mail_content" property="mailContent" />
		<result column="mail_type" property="mailType" />
		<result column="send_date" property="sendDate" />
		<result column="send_name" property="sendName" />
		<association property="mailStatus" resultMap="mailStatusResult" />
		<association property="attachment" resultMap="attachmentResult" />
	</resultMap>

	<resultMap id="mailStatusResult" type="MailStatus">
		<result column="send_mail" property="sendMail" />
		<result column="receive_mail" property="receiveMail" />
		<result column="mail_folder" property="mailFolder" />
		<result column="mail_read" property="mailRead" />
		<result column="mail_delete" property="mailDelete" />
		<result column="mail_spam" property="mailSpam" />
		<result column="mail_important" property="mailImportant" />
	</resultMap>
	
	<resultMap id="attachmentResult" type="Attachment">
		<result column="at_no" property="atNo" />
		<result column="at_ref_bno" property="atRefBno" />
		<result column="at_category" property="atCategory" />
		<result column="at_origin_name" property="atOriginName" />
		<result column="at_change_name" property="atChangeName" />
		<result column="at_status" property="atStatus" />
		<result column="at_count" property="atCount" />
	</resultMap>

	<!-- 보낸 메일 개수 조회 -->
	<select id="sendListCount" resultType="_int">
		select
		    count(*)
		from tb_mail
		where mem_no = #{memNo}
	</select>

	<!-- 보낸 메일함 조회 -->
	<select id="selectSendMailList" resultMap="mailResult">
		select
		    mail_no
		  , mem_no
		  , m.tag_no
		  , receiver_mem
		  , cc_mem
		  , to_char(send_date, 'YYYY-MM-DD(DY) HH24:MI:SS') "send_date"
		  , mail_title
		  , mail_content
		  , mail_type
		  , mail_folder
		  , mail_read
		  , mail_delete
		  , mail_spam
		  , mail_important
		  , (
		        select
		            count(*)
		        from tb_attachment
		        where at_category = 2
		          and at_ref_bno = mail_no
		  
		     ) "at_count"
		from tb_mail m
		join tb_mail_status ms using (mail_no)
		where mem_no = #{memNo}
		  and mail_folder = 1
	</select>
	
	<!-- 받은 메일 개수 조회 -->
	<select id="receiveListCount" resultType="_int">
		select
		    count(*)
		from tb_mail_status
		where receive_mail = #{memEmail}
		  and mail_folder = 2
	</select>
	
	<!-- 받은 메일 중 안읽은 메일 개수 조회 -->
	<select id="receiveUnReadCount" resultType="_int">
		select
		    count(*)
		from tb_mail_status
		where receive_mail = #{memEmail}
		  and mail_folder = 2
		  and mail_read = 'N'
	</select>
	
	<!-- 받은 메일 목록 조회 -->
	<select id="selectReceiveMailList" resultMap="mailResult">
		select
		    mail_no
		  , mem_no
		  , m.tag_no
		  , (
                select
                    mem_name
                from tb_member
                where mem_email = send_mail
            ) "send_name"
          , send_mail
		  , receive_mail
		  , cc_mem
		  , to_char(send_date, 'YYYY-MM-DD(DY) HH24:MI:SS') "send_date"
		  , mail_title
		  , mail_content
		  , mail_type
		  , mail_folder
		  , mail_read
		  , mail_delete
		  , mail_spam
		  , mail_important
		  , (
		        select
		            count(*)
		        from tb_attachment
		        where at_category = 2
		          and at_ref_bno = mail_no
		     ) "at_count"
		from tb_mail m
		join tb_mail_status ms using (mail_no)
		where mail_folder in (2,3)
		  and receive_mail = #{memEmail}
	</select>
	
	<!-- 중요메일 설정 -->
	<update id="updateImportant">
		update tb_mail_status
			<choose>
				<when test='mailImportant == "N"'>
					set mail_important = 'Y'
				</when>
				<otherwise>
					set mail_important = 'N'
				</otherwise>
			</choose>
		where mail_no = #{mailNo}
			<choose>
				<when test="receiveMail == null">
					and send_mail = #{sendMail}
				</when>
				<otherwise>
				  and receive_mail = #{receiveMail}
				</otherwise>
			</choose>
		  and mail_folder = #{mailFolder}
	</update>
	
	<!-- 메일 전송 -->
	<insert id="insertMail">
		insert
		    into tb_mail
		    (
		      mail_no
		    , mem_no
		    , receiver_mem
		    , cc_mem
		    , mail_title
		    , mail_content
		    , mail_type
		    , send_date
		    )
		 values
		    (
		      seq_mano.nextval
		    , #{memNo}
		    , #{receiverMem}
		    , #{ccMem}
		    , #{mailTitle}
		    , #{mailContent}
		   	<if test="mailType != null">
		   	, 1
		   	</if>
		    <if test="mailType == null">
		    , 2
		    </if>
		    , sysdate
		    )
	</insert>
	
	<!-- 메일 상태 전송 -->
	<insert id="insertMailStatus">
		insert 
		    into tb_mail_status
		    (
		      mail_no
		    , send_mail
		    , receive_mail
		    , mail_folder
		    )
		 values
		    (
		      seq_mano.currval
		    , #{sendMail}
		    , #{receiveMail}
		    , #{mailFolder}
		     )
	</insert>
	
	<!-- 첨부파일 전송 -->
	<insert id="insertAttachment">
  		insert
  		  into tb_attachment
  		  (
  		  	at_no
  		  , at_ref_bno
  		  , at_category
  		  , at_origin_name
  		  , at_change_name
  		  )
  		  values
  		  (
  		  	seq_atno.nextval
  		  , seq_mano.currval
  		  , 2
  		  , #{atOriginName}
  		  , #{atChangeName}
  		  )
	</insert>

</mapper>
